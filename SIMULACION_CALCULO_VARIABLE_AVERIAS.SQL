
	DROP TABLE [PV_STC_Comisiones]..AVERIAS_OCTUBRE_COMPLETO

	DECLARE @NPS_PROMOTOR_AVERIAS FLOAT
	DECLARE @NPS_NEUTRO_AVERIAS FLOAT
	DECLARE @NPS_DETRACTOR_AVERIAS FLOAT
	DECLARE @FACT_TCFL_LIM_INF FLOAT
	DECLARE @FACT_TCFL_LIM_SUP FLOAT
	DECLARE @FACT_AGENDA_LIM_INF FLOAT
	DECLARE @FACT_AGENDA_LIM_SUP FLOAT
	DECLARE @CUMPL_TCFL_LIM_INF FLOAT
	DECLARE @CUMPL_TCFL_LIM_SUP FLOAT
	DECLARE @CUMPL_AGENDA_LIM_INF FLOAT
	DECLARE @CUMPL_AGENDA_LIM_SUP FLOAT
	DECLARE @PESO_TCFL FLOAT
	DECLARE @PESO_AGENDA FLOAT

	--DECLARO PESOS DE NPS PARA AVERIAS

	SET @NPS_PROMOTOR_AVERIAS = 1.5
	SET @NPS_NEUTRO_AVERIAS  = 1
	SET @NPS_DETRACTOR_AVERIAS = 0.5

	--Y=Y0+((X-Xo)/(X1-Xo))*(Y1-Yo)

	--DECLARO LIMITES DEL CUMPLIMIENTO DE  TCFL Y DE EFECTIVIDADES
	SET @CUMPL_TCFL_LIM_INF = 0.81		--Xo
	SET @CUMPL_TCFL_LIM_SUP = 1.06		--X1

	SET @FACT_TCFL_LIM_INF = 0.75		--Yo
	SET @FACT_TCFL_LIM_SUP = 1.2		--Y1


	--DECLARO LIMITES DEL CUMPLIMIENTO DE  AGENDA
	SET @CUMPL_AGENDA_LIM_INF = 0.81	--Xo
	SET @CUMPL_AGENDA_LIM_SUP = 1.06	--X1

	SET @FACT_AGENDA_LIM_INF = 0.75		--Yo
	SET @FACT_AGENDA_LIM_SUP = 1.1	    --Y1

	--DECLARO EL PESO DE CADA VARIABLE
	SET @PESO_TCFL = 0.5
	SET @PESO_AGENDA = 0.5

	SELECT
	A.*,
	CT.REITERADA_CUARTIL,
	CT.INEFECTIVA_CUARTIL,
	CTR.REITERADA_RESULTADO,
	CTR.INEFECTIVA_RESULTADO,
	CUMPL.AGENDA_OBJETIVO,
	CUMPL.TCFL_OBJETIVO,
	CUMPL.AGENDA_RESULTADO,
	CUMPL.TCFL_RESULTADO,
	NPS.PROMOTOR,
	NPS.NEUTRO,
	NPS.DETRACTOR,
	((CTR.REITERADA_RESULTADO-CT.REITERADA_CUARTIL) + (CTR.INEFECTIVA_RESULTADO-CT.INEFECTIVA_CUARTIL)) AS 'EXCESO',
	(1-((CTR.REITERADA_RESULTADO-CT.REITERADA_CUARTIL) + (CTR.INEFECTIVA_RESULTADO-CT.INEFECTIVA_CUARTIL)))*A.BAR_BRUTOS AS 'EVENTOS_PRODUCTIVOS',
	(NPS.PROMOTOR*@NPS_PROMOTOR_AVERIAS+NPS.NEUTRO*@NPS_NEUTRO_AVERIAS+NPS.DETRACTOR*@NPS_DETRACTOR_AVERIAS) AS 'FACTOR_NPS',
	CASE WHEN TCFL_OBJETIVO = 0 THEN 0 ELSE (TCFL_RESULTADO/TCFL_OBJETIVO) END AS '%CUMPL_TCFL',
	CASE WHEN AGENDA_OBJETIVO = 0 THEN 0 ELSE (AGENDA_RESULTADO/AGENDA_OBJETIVO) END AS '%CUMPL_AGENDA',
	CASE
		WHEN CASE WHEN TCFL_OBJETIVO = 0 THEN 0 ELSE (TCFL_RESULTADO/TCFL_OBJETIVO) END < @CUMPL_TCFL_LIM_INF THEN 0
		WHEN CASE WHEN TCFL_OBJETIVO = 0 THEN 0 ELSE (TCFL_RESULTADO/TCFL_OBJETIVO) END > @CUMPL_TCFL_LIM_SUP THEN @FACT_TCFL_LIM_SUP
		ELSE (@FACT_TCFL_LIM_INF+((CASE WHEN TCFL_OBJETIVO = 0 THEN 0 ELSE (TCFL_RESULTADO/TCFL_OBJETIVO) END-@CUMPL_TCFL_LIM_INF)/(@CUMPL_TCFL_LIM_SUP-@CUMPL_TCFL_LIM_INF))*(@FACT_TCFL_LIM_SUP-@FACT_TCFL_LIM_INF))
	END	*@PESO_TCFL +
	CASE
		WHEN CASE WHEN AGENDA_OBJETIVO = 0 THEN 0 ELSE (AGENDA_RESULTADO/AGENDA_OBJETIVO) END < @CUMPL_AGENDA_LIM_INF THEN 0
		WHEN CASE WHEN AGENDA_OBJETIVO = 0 THEN 0 ELSE (AGENDA_RESULTADO/AGENDA_OBJETIVO) END > @CUMPL_AGENDA_LIM_SUP THEN @FACT_AGENDA_LIM_SUP
		ELSE (@FACT_AGENDA_LIM_INF+((CASE WHEN AGENDA_OBJETIVO = 0 THEN 0 ELSE (AGENDA_RESULTADO/AGENDA_OBJETIVO) END-@CUMPL_AGENDA_LIM_INF)/(@CUMPL_AGENDA_LIM_SUP-@CUMPL_AGENDA_LIM_INF))*(@FACT_AGENDA_LIM_SUP-@FACT_AGENDA_LIM_INF))
	END	*@PESO_AGENDA AS EFECTIVIDAD,
	PB.PRECIO
	INTO [PV_STC_Comisiones]..AVERIAS_OCTUBRE_COMPLETO
	FROM
	[PV_STC_Comisiones]..AVERIAS_OCTUBRE A
	LEFT JOIN
	[PV_STC_Comisiones]..AVERIAS_CUARTIL CT
	ON
	CT.REGION=A.REGION
	LEFT JOIN
	[PV_STC_Comisiones]..AVERIAS_RESULTADO CTR
	ON
	CTR.REGION=A.REGION AND
	CTR.EECC=A.EECC AND
	CTR.JEF_CMR=A.JEF_CMR
	LEFT JOIN [PV_STC_Comisiones]..AVERIAS_OBJ_RESUL_CUMPL CUMPL
	ON
	CUMPL.REGION=A.REGION AND
	CUMPL.EECC=A.EECC AND
	CUMPL.JEF_CMR=A.JEF_CMR
	LEFT JOIN
	[PV_STC_Comisiones]..CALCULO_AVERIAS_NPS NPS
	ON
	NPS.REGION=A.REGION AND
	NPS.EECC=A.EECC
	LEFT JOIN
	[PV_STC_Comisiones]..PRECIOS_NUEVO PB
	ON
	PB.CONTRA=A.EECC AND
	(CASE WHEN A.REGION='REGION LIMA' THEN 'LIM' ELSE 'PRO' END) = PB.ZONAL
	GO

	DECLARE @FACT_LIM_INF FLOAT
	DECLARE @FACT_LIM_SUP FLOAT

	--DEFINO LOS LÍMITES DE FACTURACIÓN DEL VARIABLE
	SET @FACT_LIM_INF = 0.85
	SET @FACT_LIM_SUP = 1.15

	SELECT
	A.*,
	A.EVENTOS_PRODUCTIVOS*A.FACTOR_NPS/**FDS*/*A.EFECTIVIDAD*A.PRECIO AS 'FACTURA_SIMULADA',
	A.EVENTOS_PRODUCTIVOS*A.PRECIO AS 'PXQ',
	CASE
		WHEN (A.EVENTOS_PRODUCTIVOS*A.FACTOR_NPS/**FDS*/*A.EFECTIVIDAD*A.PRECIO)/(A.EVENTOS_PRODUCTIVOS*A.PRECIO ) < @FACT_LIM_INF THEN (A.EVENTOS_PRODUCTIVOS*A.PRECIO )*@FACT_LIM_INF
		WHEN (A.EVENTOS_PRODUCTIVOS*A.FACTOR_NPS/**FDS*/*A.EFECTIVIDAD*A.PRECIO)/(A.EVENTOS_PRODUCTIVOS*A.PRECIO ) > @FACT_LIM_SUP THEN (A.EVENTOS_PRODUCTIVOS*A.PRECIO )*@FACT_LIM_SUP
	ELSE A.EVENTOS_PRODUCTIVOS*A.FACTOR_NPS/**FDS*/*A.EFECTIVIDAD*A.PRECIO END AS 'FACTURACION_FINAL'
	FROM
	[PV_STC_Comisiones]..AVERIAS_OCTUBRE_COMPLETO A
